name: Publish to PyPI
on:
  release:
    types: [published]
jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Build and publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          pip install build twine
          
          # Verify version consistency
          PYPROJECT_VERSION=$(grep -Po '^version = "\K[^"]*' pyproject.toml)
          INIT_VERSION=$(grep -Po '(?<=__version__ = ")[^"]*' src/icw/__init__.py)
          
          echo "Version in pyproject.toml: $PYPROJECT_VERSION"
          echo "Version in __init__.py: $INIT_VERSION"
          
          if [ "$PYPROJECT_VERSION" != "$INIT_VERSION" ]; then
            echo "ERROR: Version mismatch between pyproject.toml and __init__.py"
            exit 1
          fi
          
          # Build and publish
          python -m build
          twine check dist/*
          twine upload dist/*
          
          echo "âœ… Published to PyPI: v$PYPROJECT_VERSION"
